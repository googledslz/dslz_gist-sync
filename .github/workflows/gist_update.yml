name: Smart Sync Gist

on:
  schedule:
    - cron: "*/10 * * * *"   # æ¯10åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
  workflow_dispatch:         # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  smart-update-gist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Run smart update script
        run: |
          import os, requests, pathlib

          token = os.environ["GIST_TOKEN"]
          gist_id = "08aeffb9aeaf3d134b4fc993da570f5c"

          # ç¼“å­˜æ–‡ä»¶è·¯å¾„
          cache_file = pathlib.Path("zhu_he_last.txt")

          # gist åŸå§‹åœ°å€
          zhu_he_url = f"https://gist.githubusercontent.com/googledslz/{gist_id}/raw/ZHU_HE"
          fu_xie_a_url = f"https://gist.githubusercontent.com/googledslz/{gist_id}/raw/fu_xie_A"

          # æ‹‰å–æœ€æ–°å†…å®¹
          zhu_he_content = requests.get(zhu_he_url).text.strip()
          fu_xie_a_content = requests.get(fu_xie_a_url).text.strip()

          # æ‹¼æ¥æœ€ç»ˆå†…å®¹
          updated_content = zhu_he_content + "\n" + fu_xie_a_content

          # è¯»å–ç¼“å­˜ï¼ˆä¸Šæ¬¡çš„å®Œæ•´å†…å®¹ï¼‰
          old_content = ""
          if cache_file.exists():
              old_content = cache_file.read_text().strip()

          # å¯¹æ¯”
          if updated_content == old_content:
              print("âœ… ZHU_HE + fu_xie_A æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°")
          else:
              print("ğŸ”„ æ£€æµ‹åˆ°å˜åŒ–ï¼Œå‡†å¤‡æ›´æ–° gist")

              # æ›´æ–° gist
              update_url = f"https://api.github.com/gists/{gist_id}"
              headers = {"Authorization": f"token {token}"}
              data = {
                  "files": {
                      "ZHU_HE": {
                          "content": updated_content
                      }
                  }
              }

              res = requests.patch(update_url, headers=headers, json=data)
              print("Update status:", res.status_code, res.text)

              # æ›´æ–°ç¼“å­˜ä¸ºå®Œæ•´å†…å®¹
              cache_file.write_text(updated_content)

        shell: python

      - name: Commit cache file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add zhu_he_last.txt
          git commit -m "update cache file" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    env:
      GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
